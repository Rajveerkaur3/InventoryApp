<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .table-responsive { max-height: 400px; overflow-y: auto; }
        .form-section { background: #f8f9fa; padding: 20px; border-radius: 5px; }
        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                 background: rgba(0,0,0,0.5); z-index: 1000; }
        .spinner-border { width: 3rem; height: 3rem; }
        .low-stock { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">Inventory Management</h1>
        
        <!-- Status Alert -->
        <div class="alert alert-info mb-3">
            API Status: <span id="apiStatus">Checking...</span>
            <span class="float-end" id="lastUpdated"></span>
        </div>

        <!-- Loading Overlay -->
        <div id="loading" class="d-flex justify-content-center align-items-center">
            <div class="spinner-border text-light"></div>
        </div>

        <!-- View Inventory -->
        <div class="mb-5">
            <h2>Current Inventory</h2>
            <div class="table-responsive">
                <table class="table table-striped" id="inventoryTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryList"></tbody>
                </table>
            </div>
            <button class="btn btn-primary" onclick="loadInventory()">Refresh</button>
        </div>

        <!-- Add Item -->
        <div class="form-section mb-5">
            <h2>Add New Item</h2>
            <form id="addItemForm">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="item_name" placeholder="Name" required>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="item_description" placeholder="Description">
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" name="item_qty_on_hand" placeholder="Qty" min="0" required>
                    </div>
                    <div class="col-md-2">
                        <input type="number" step="0.01" class="form-control" name="item_price" placeholder="Price" min="0" required>
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" name="item_location_id" placeholder="Location ID" required>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-success w-100">Add Item</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        const API_BASE_URL = 'https://r1o68l7ki6.execute-api.us-east-1.amazonaws.com/dev';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkApiStatus();
            loadInventory();
        });

        // Check API connectivity
        async function checkApiStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/item`);
                const statusEl = document.getElementById('apiStatus');
                if (response.ok) {
                    statusEl.textContent = 'Connected';
                    statusEl.className = 'text-success';
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                document.getElementById('apiStatus').textContent = 'Disconnected';
                document.getElementById('apiStatus').className = 'text-danger';
                console.error('API check failed:', error);
            }
        }

        // Load inventory
        async function loadInventory() {
            showLoading(true);
            try {
                const response = await fetch(`${API_BASE_URL}/item`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const items = await response.json();
                renderInventory(items);
                updateTimestamp();
            } catch (error) {
                console.error('Inventory load failed:', error);
                alert('Failed to load inventory. See console for details.');
            } finally {
                showLoading(false);
            }
        }

        // Render inventory table
        function renderInventory(items) {
            const tableBody = document.getElementById('inventoryList');
            tableBody.innerHTML = items.map(item => `
                <tr>
                    <td>${item.item_id || 'N/A'}</td>
                    <td>${item.item_name || 'N/A'}</td>
                    <td>${item.item_description || '-'}</td>
                    <td class="${item.item_qty_on_hand <= 5 ? 'low-stock' : ''}">
                        ${item.item_qty_on_hand || 0}
                    </td>
                    <td>$${(item.item_price || 0).toFixed(2)}</td>
                    <td>${item.item_location_id || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteItem('${item.item_id}')">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Add new item
        document.getElementById('addItemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            
            const formData = new FormData(e.target);
            const data = {
                item_name: formData.get('item_name'),
                item_description: formData.get('item_description'),
                item_qty_on_hand: parseInt(formData.get('item_qty_on_hand')),
                item_price: parseFloat(formData.get('item_price')),
                item_location_id: parseInt(formData.get('item_location_id'))
            };

            try {
                const response = await fetch(`${API_BASE_URL}/item`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to add item');
                }
                
                e.target.reset();
                loadInventory();
            } catch (error) {
                console.error('Add item failed:', error);
                alert(`Error: ${error.message}`);
            } finally {
                showLoading(false);
            }
        });

        // Delete item
        async function deleteItem(itemId) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE_URL}/item/${itemId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error(await response.text());
                loadInventory();
            } catch (error) {
                console.error('Delete failed:', error);
                alert('Failed to delete item. See console for details.');
            } finally {
                showLoading(false);
            }
        }

        // Helper functions
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
        
        function updateTimestamp() {
            document.getElementById('lastUpdated').textContent = 
                'Last updated: ' + new Date().toLocaleTimeString();
        }
    </script>
</body>
</html>
